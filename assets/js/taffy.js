var TAFFY,exports,T;!function(){"use strict";var t,e,n,r,i,s,u,o,c,a,l,f,h,g,F,p,d,A,y,_,v,m,x,Y;if(!TAFFY)for(i="2.7",s=1,u="000000",o=1e3,c={},Y=function(t){return Array.prototype.slice.call(t).sort()},a=function(t){return TAFFY.isArray(t)||TAFFY.isObject(t)?t:JSON.parse(t)},y=function(t,e){return _(t,function(t){return e.indexOf(t)>=0})},_=function(t,e,n){var r=[];return null==t?r:Array.prototype.filter&&t.filter===Array.prototype.filter?t.filter(e,n):(l(t,function(t,i,s){e.call(n,t,i,s)&&(r[r.length]=t)}),r)},x=function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},m=function(t){var e=T.isArray(t)?[]:T.isObject(t)?{}:null;if(null===t)return t;for(var n in t)e[n]=x(t[n])?t[n].toString():T.isArray(t[n])||T.isObject(t[n])?m(t[n]):t[n];return e},v=function(t){var e=JSON.stringify(t);return null===e.match(/regex/)?e:JSON.stringify(m(t))},l=function(t,e,n){var r,i,s,u;if(t&&(T.isArray(t)&&1===t.length||!T.isArray(t)))e(T.isArray(t)?t[0]:t,0);else for(s=0,t=T.isArray(t)?t:[t],u=t.length;s<u&&(i=t[s],T.isUndefined(i)&&!n||(r=e(i,s))!==T.EXIT);s++);},f=function(t,e){var n=0,r,i;for(i in t)if(t.hasOwnProperty(i)&&(r=e(t[i],i,n++))===T.EXIT)break},c.extend=function(t,e){c[t]=function(){return e.apply(this,Y(arguments))}},h=function(t){var e;return!(!T.isString(t)||!/[t][0-9]*[r][0-9]*/i.test(t))||(!!(T.isObject(t)&&t.___id&&t.___s)||!!T.isArray(t)&&(e=!0,l(t,function(t){if(!h(t))return e=!1,TAFFY.EXIT}),e))},F=function(t,e){var n=!0;return l(e,function(e){switch(T.typeOf(e)){case"function":if(!e.apply(t))return n=!1,TAFFY.EXIT;break;case"array":n=1===e.length?F(t,e[0]):2===e.length?F(t,e[0])||F(t,e[1]):3===e.length?F(t,e[0])||F(t,e[1])||F(t,e[2]):4===e.length&&(F(t,e[0])||F(t,e[1])||F(t,e[2])||F(t,e[3])),e.length>4&&l(e,function(e){F(t,e)&&(n=!0)});break}}),n},g=function(t){var e=[];return T.isString(t)&&/[t][0-9]*[r][0-9]*/i.test(t)&&(t={___id:t}),T.isArray(t)?(l(t,function(t){e.push(g(t))}),t=function(){var t=this,n=!1;return l(e,function(e){F(t,e)&&(n=!0)}),n}):T.isObject(t)?(T.isObject(t)&&t.___id&&t.___s&&(t={___id:t.___id}),f(t,function(t,n){T.isObject(t)||(t={is:t}),f(t,function(t,r){var i=[],s;s="hasAll"===r?function(t,e){e(t)}:l,s(t,function(t){var e=!0,s=!1,u;u=function(){var i=this[n],s="==",u="!=",o="===",c="<",a=">",l="<=",f=">=",h="!==",g;return void 0!==i&&(0===r.indexOf("!")&&"!="!==r&&"!=="!==r&&(e=!1,r=r.substring(1,r.length)),g="regex"===r?t.test(i):"lt"===r||r===c?i<t:"gt"===r||r===a?i>t:"lte"===r||"<="===r?i<=t:"gte"===r||">="===r?i>=t:"left"===r?0===i.indexOf(t):"leftnocase"===r?0===i.toLowerCase().indexOf(t.toLowerCase()):"right"===r?i.substring(i.length-t.length)===t:"rightnocase"===r?i.toLowerCase().substring(i.length-t.length)===t.toLowerCase():"like"===r?i.indexOf(t)>=0:"likenocase"===r?i.toLowerCase().indexOf(t.toLowerCase())>=0:"==="===r||"is"===r?i===t:"=="===r?i==t:"!=="===r?i!==t:"!="===r?i!=t:"isnocase"===r?i.toLowerCase?i.toLowerCase()===t.toLowerCase():i===t:"has"===r?T.has(i,t):"hasall"===r?T.hasAll(i,t):"contains"===r?TAFFY.isArray(i)&&i.indexOf(t)>-1:-1!==r.indexOf("is")||TAFFY.isNull(i)||TAFFY.isUndefined(i)||TAFFY.isObject(t)||TAFFY.isArray(t)?T[r]&&T.isFunction(T[r])&&0===r.indexOf("is")?T[r](i)===t:!(!T[r]||!T.isFunction(T[r]))&&T[r](i,t):t===i[r],g=!(g&&!e)&&(!g&&!e||g))},i.push(u)}),1===i.length?e.push(i[0]):e.push(function(){var t=this,e=!1;return l(i,function(n){n.apply(t)&&(e=!0)}),e})})}),t=function(){var t=this,n=!0;return n=!(1===e.length&&!e[0].apply(t))&&(!!(2!==e.length||e[0].apply(t)&&e[1].apply(t))&&(!!(3!==e.length||e[0].apply(t)&&e[1].apply(t)&&e[2].apply(t))&&!!(4!==e.length||e[0].apply(t)&&e[1].apply(t)&&e[2].apply(t)&&e[3].apply(t)))),e.length>4&&l(e,function(e){F(t,e)||(n=!1)}),n}):T.isFunction(t)?t:void 0},d=function(t,e){var n=function(t,n){var r=0;return T.each(e,function(e){var i,s,u,o,c;if(i=e.split(" "),s=i[0],"logical"===(u=1===i.length?"logical":i[1]))o=p(t[s]),c=p(n[s]),T.each(o.length<=c.length?o:c,function(t,e){return o[e]<c[e]?(r=-1,TAFFY.EXIT):o[e]>c[e]?(r=1,TAFFY.EXIT):void 0});else if("logicaldesc"===u)o=p(t[s]),c=p(n[s]),T.each(o.length<=c.length?o:c,function(t,e){return o[e]>c[e]?(r=-1,TAFFY.EXIT):o[e]<c[e]?(r=1,TAFFY.EXIT):void 0});else{if("asec"===u&&t[s]<n[s])return r=-1,T.EXIT;if("asec"===u&&t[s]>n[s])return r=1,T.EXIT;if("desc"===u&&t[s]>n[s])return r=-1,T.EXIT;if("desc"===u&&t[s]<n[s])return r=1,T.EXIT}if(0===r&&"logical"===u&&o.length<c.length?r=-1:0===r&&"logical"===u&&o.length>c.length?r=1:0===r&&"logicaldesc"===u&&o.length>c.length?r=-1:0===r&&"logicaldesc"===u&&o.length<c.length&&(r=1),0!==r)return T.EXIT}),r};return t&&t.push?t.sort(n):t},function(){var t={},e=0;p=function(n){return e>o&&(t={},e=0),t["_"+n]||function(){var r=String(n),i=[],s="_",u="",o,c,a;for(o=0,c=r.length;o<c;o++)a=r.charCodeAt(o),a>=48&&a<=57||46===a?("n"!==u&&(u="n",i.push(s.toLowerCase()),s=""),s+=r.charAt(o)):("s"!==u&&(u="s",i.push(parseFloat(s)),s=""),s+=r.charAt(o));return i.push("n"===u?parseFloat(s):s.toLowerCase()),i.shift(),t["_"+n]=i,e++,i}()}}(),A=function(){this.context({results:this.getDBI().query(this.context())})},c.extend("filter",function(){var t=TAFFY.mergeObj(this.context(),{run:null}),e=[];return l(t.q,function(t){e.push(t)}),t.q=e,l(Y(arguments),function(e){t.q.push(g(e)),t.filterRaw.push(e)}),this.getroot(t)}),c.extend("order",function(t){t=t.split(",");var e=[],n;return l(t,function(t){e.push(t.replace(/^\s*/,"").replace(/\s*$/,""))}),n=TAFFY.mergeObj(this.context(),{sort:null}),n.order=e,this.getroot(n)}),c.extend("limit",function(t){var e=TAFFY.mergeObj(this.context(),{}),n;return e.limit=t,e.run&&e.sort&&(n=[],l(e.results,function(e,r){if(r+1>t)return TAFFY.EXIT;n.push(e)}),e.results=n),this.getroot(e)}),c.extend("start",function(t){var e=TAFFY.mergeObj(this.context(),{}),n;return e.start=t,e.run&&e.sort&&!e.limit?(n=[],l(e.results,function(e,r){r+1>t&&n.push(e)}),e.results=n):e=TAFFY.mergeObj(this.context(),{run:null,start:t}),this.getroot(e)}),c.extend("update",function(t,e,n){var r=!0,i={},s=Y(arguments),u;return!TAFFY.isString(t)||2!==arguments.length&&3!==arguments.length?(i=t,2===s.length&&(r=e)):(i[t]=e,3===arguments.length&&(r=n)),u=this,A.call(this),l(this.context().results,function(t){var e=i;TAFFY.isFunction(e)?e=e.apply(TAFFY.mergeObj(t,{})):T.isFunction(e)&&(e=e(TAFFY.mergeObj(t,{}))),TAFFY.isObject(e)&&u.getDBI().update(t.___id,e,r)}),this.context().results.length&&this.context({run:null}),this}),c.extend("remove",function(t){var e=this,n=0;return A.call(this),l(this.context().results,function(t){e.getDBI().remove(t.___id),n++}),this.context().results.length&&(this.context({run:null}),e.getDBI().removeCommit(t)),n}),c.extend("count",function(){return A.call(this),this.context().results.length}),c.extend("callback",function(t,e){if(t){var n=this;setTimeout(function(){A.call(n),t.call(n.getroot(n.context()))},e||0)}return null}),c.extend("get",function(){return A.call(this),this.context().results}),c.extend("stringify",function(){return JSON.stringify(this.get())}),c.extend("first",function(){return A.call(this),this.context().results[0]||!1}),c.extend("last",function(){return A.call(this),this.context().results[this.context().results.length-1]||!1}),c.extend("sum",function(){var t=0,e=this;return A.call(e),l(Y(arguments),function(n){l(e.context().results,function(e){t+=e[n]||0})}),t}),c.extend("min",function(t){var e=null;return A.call(this),l(this.context().results,function(n){(null===e||n[t]<e)&&(e=n[t])}),e}),function(){var t=function(){var t,e,n;return t=function(t,e,n){var r,i,s,u;switch(2===n.length?(r=t[n[0]],s="===",i=e[n[1]]):(r=t[n[0]],s=n[1],i=e[n[2]]),s){case"===":return r===i;case"!==":return r!==i;case"<":return r<i;case">":return r>i;case"<=":return r<=i;case">=":return r>=i;case"==":return r==i;case"!=":return r!=i;default:throw String(s)+" is not supported"}},e=function(t,e){var n={},r,i;for(r in t)t.hasOwnProperty(r)&&(n[r]=t[r]);for(r in e)e.hasOwnProperty(r)&&"___id"!==r&&"___s"!==r&&(i=TAFFY.isUndefined(n[r])?"":"right_",n[i+String(r)]=e[r]);return n},n=function(n){var r,i,s=Y(arguments),u=s.length,o=[];if("function"!=typeof n.filter){if(!n.TAFFY)throw"TAFFY DB or result not supplied";r=n()}else r=n;return this.context({results:this.getDBI().query(this.context())}),TAFFY.each(this.context().results,function(n){r.each(function(r){var c,a=!0;t:for(i=1;i<u&&(c=s[i],a="function"==typeof c?c(n,r):!("object"!=typeof c||!c.length)&&t(n,r,c));i++);a&&o.push(e(n,r))})}),TAFFY(o)()}}();c.extend("join",t)}(),c.extend("max",function(t){var e=null;return A.call(this),l(this.context().results,function(n){(null===e||n[t]>e)&&(e=n[t])}),e}),c.extend("select",function(){var t=[],e=Y(arguments);return A.call(this),1===arguments.length?l(this.context().results,function(n){t.push(n[e[0]])}):l(this.context().results,function(n){var r=[];l(e,function(t){r.push(n[t])}),t.push(r)}),t}),c.extend("distinct",function(){var t=[],e=Y(arguments);return A.call(this),1===arguments.length?l(this.context().results,function(n){var r=n[e[0]],i=!1;l(t,function(t){if(r===t)return i=!0,TAFFY.EXIT}),i||t.push(r)}):l(this.context().results,function(n){var r=[],i=!1;l(e,function(t){r.push(n[t])}),l(t,function(t){var n=!0;if(l(e,function(e,i){if(r[i]!==t[i])return n=!1,TAFFY.EXIT}),n)return i=!0,TAFFY.EXIT}),i||t.push(r)}),t}),c.extend("supplant",function(t,e){var n=[];return A.call(this),l(this.context().results,function(e){n.push(t.replace(/\{([^\{\}]*)\}/g,function(t,n){var r=e[n];return"string"==typeof r||"number"==typeof r?r:t}))}),e?n:n.join("")}),c.extend("each",function(t){return A.call(this),l(this.context().results,t),this}),c.extend("map",function(t){var e=[];return A.call(this),l(this.context().results,function(n){e.push(t(n))}),e}),T=function(t){var e=[],n={},r=1,i={template:!1,onInsert:!1,onUpdate:!1,onRemove:!1,onDBChange:!1,storageName:!1,forcePropertyCase:null,cacheSize:100,name:""},o=new Date,p=0,A=0,y={},_,m,x;return m=function(t){var r=[],i=!1;return 0===t.length?e:(l(t,function(t){T.isString(t)&&/[t][0-9]*[r][0-9]*/i.test(t)&&e[n[t]]&&(r.push(e[n[t]]),i=!0),T.isObject(t)&&t.___id&&t.___s&&e[n[t.___id]]&&(r.push(e[n[t.___id]]),i=!0),T.isArray(t)&&l(t,function(t){l(m(t),function(t){r.push(t)})})}),i&&r.length>1&&(r=[]),r)},_={dm:function(t){return t&&(o=t,y={},p=0,A=0),i.onDBChange&&setTimeout(function(){i.onDBChange.call(e)},0),i.storageName&&setTimeout(function(){localStorage.setItem("taffy_"+i.storageName,JSON.stringify(e))}),o},insert:function(t,o){var c=[],h=[],g=a(t);return l(g,function(t,a){var g,F;if(T.isArray(t)&&0===a)return l(t,function(t){c.push("lower"===i.forcePropertyCase?t.toLowerCase():"upper"===i.forcePropertyCase?t.toUpperCase():t)}),!0;T.isArray(t)?(g={},l(t,function(t,e){g[c[e]]=t}),t=g):T.isObject(t)&&i.forcePropertyCase&&(F={},f(t,function(e,n){F["lower"===i.forcePropertyCase?n.toLowerCase():"upper"===i.forcePropertyCase?n.toUpperCase():n]=t[n]}),t=F),r++,t.___id="T"+String(u+s).slice(-6)+"R"+String(u+r).slice(-6),t.___s=!0,h.push(t.___id),i.template&&(t=T.mergeObj(i.template,t)),e.push(t),n[t.___id]=e.length-1,i.onInsert&&(o||TAFFY.isUndefined(o))&&i.onInsert.call(t),_.dm(new Date)}),x(h)},sort:function(t){return e=d(e,t.split(",")),n={},l(e,function(t,e){n[t.___id]=e}),_.dm(new Date),!0},update:function(t,r,s){var u={},o,c,a,l;i.forcePropertyCase&&(f(r,function(t,e){u["lower"===i.forcePropertyCase?e.toLowerCase():"upper"===i.forcePropertyCase?e.toUpperCase():e]=t}),r=u),o=e[n[t]],c=T.mergeObj(o,r),a={},l=!1,f(c,function(t,e){(TAFFY.isUndefined(o[e])||o[e]!==t)&&(a[e]=t,l=!0)}),l&&(i.onUpdate&&(s||TAFFY.isUndefined(s))&&i.onUpdate.call(c,e[n[t]],a),e[n[t]]=c,_.dm(new Date))},remove:function(t){e[n[t]].___s=!1},removeCommit:function(t){var r;for(r=e.length-1;r>-1;r--)e[r].___s||(i.onRemove&&(t||TAFFY.isUndefined(t))&&i.onRemove.call(e[r]),n[e[r].___id]=void 0,e.splice(r,1));n={},l(e,function(t,e){n[t.___id]=e}),_.dm(new Date)},query:function(t){var n,r,s,u,o,c;if(i.cacheSize&&(r="",l(t.filterRaw,function(t){if(T.isFunction(t))return r="nocache",TAFFY.EXIT}),""===r&&(r=v(T.mergeObj(t,{q:!1,run:!1,sort:!1})))),!t.results||!t.run||t.run&&_.dm()>t.run){if(s=[],i.cacheSize&&y[r])return y[r].i=p++,y[r].results;0===t.q.length&&0===t.index.length?(l(e,function(t){s.push(t)}),n=s):(u=m(t.index),l(u,function(e){(0===t.q.length||F(e,t.q))&&s.push(e)}),n=s)}else n=t.results;return!(t.order.length>0)||t.run&&t.sort||(n=d(n,t.order)),n.length&&(t.limit&&t.limit<n.length||t.start)&&(o=[],l(n,function(e,n){if(!t.start||t.start&&n+1>=t.start)if(t.limit){if((c=t.start?n+1-t.start:n)<t.limit)o.push(e);else if(c>t.limit)return TAFFY.EXIT}else o.push(e)}),n=o),i.cacheSize&&"nocache"!==r&&(A++,setTimeout(function(){var t,e;A>=2*i.cacheSize&&(A=0,t=p-i.cacheSize,e={},f(function(n,r){n.i>=t&&(e[r]=n)}),y=e)},0),y[r]={i:p++,results:n}),n}},x=function(){var t,e;return t=TAFFY.mergeObj(TAFFY.mergeObj(c,{insert:void 0}),{getDBI:function(){return _},getroot:function(t){return x.call(t)},context:function(t){return t&&(e=TAFFY.mergeObj(e,t.hasOwnProperty("results")?TAFFY.mergeObj(t,{run:new Date,sort:new Date}):t)),e},extend:void 0}),e=this&&this.q?this:{limit:!1,start:!1,q:[],filterRaw:[],index:[],order:[],results:!1,run:null,sort:null,settings:i},l(Y(arguments),function(t){h(t)?e.index.push(t):e.q.push(g(t)),e.filterRaw.push(t)}),t},s++,t&&_.insert(t),x.insert=_.insert,x.merge=function(t,e,n){var r={},i=[],s={};return n=n||!1,e=e||"id",l(t,function(t){var s;r[e]=t[e],i.push(t[e]),s=x(r).first(),s?_.update(s.___id,t,n):_.insert(t,n)}),s[e]=i,x(s)},x.TAFFY=!0,x.sort=_.sort,x.settings=function(t){return t&&(i=TAFFY.mergeObj(i,t),t.template&&x().update(t.template)),i},x.store=function(t){var n=!1,r;return localStorage&&(t&&(r=localStorage.getItem("taffy_"+t),r&&r.length>0&&(x.insert(r),n=!0),e.length>0&&setTimeout(function(){localStorage.setItem("taffy_"+i.storageName,JSON.stringify(e))})),x.settings({storageName:t})),x},x},TAFFY=T,T.each=l,T.eachin=f,T.extend=c.extend,TAFFY.EXIT="TAFFYEXIT",TAFFY.mergeObj=function(t,e){var n={};return f(t,function(e,r){n[r]=t[r]}),f(e,function(t,r){n[r]=e[r]}),n},TAFFY.has=function(t,e){var n=!1,r;if(t.TAFFY)return n=t(e),n.length>0;switch(T.typeOf(t)){case"object":if(T.isObject(e))f(e,function(r,i){if(!0!==n||T.isUndefined(t[i])||!t.hasOwnProperty(i))return n=!1,TAFFY.EXIT;n=T.has(t[i],e[i])});else if(T.isArray(e))l(e,function(r,i){if(n=T.has(t,e[i]))return TAFFY.EXIT});else if(T.isString(e))return!TAFFY.isUndefined(t[e]);return n;case"array":if(T.isObject(e))l(t,function(r,i){if(!0===(n=T.has(t[i],e)))return TAFFY.EXIT});else if(T.isArray(e))l(e,function(r,i){if(l(t,function(r,s){if(!0===(n=T.has(t[s],e[i])))return TAFFY.EXIT}),!0===n)return TAFFY.EXIT});else if(T.isString(e)||T.isNumber(e))for(n=!1,r=0;r<t.length;r++)if(n=T.has(t[r],e))return!0;return n;case"string":if(T.isString(e)&&e===t)return!0;break;default:if(T.typeOf(t)===T.typeOf(e)&&t===e)return!0;break}return!1},TAFFY.hasAll=function(t,e){var n=TAFFY,r;return n.isArray(e)?(r=!0,l(e,function(e){if(!1===(r=n.has(t,e)))return TAFFY.EXIT}),r):n.has(t,e)},TAFFY.typeOf=function(t){var e=typeof t;return"object"===e&&(t?"number"!=typeof t.length||t.propertyIsEnumerable("length")||(e="array"):e="null"),e},TAFFY.getObjectKeys=function(t){var e=[];return f(t,function(t,n){e.push(n)}),e.sort(),e},TAFFY.isSameArray=function(t,e){return!(!TAFFY.isArray(t)||!TAFFY.isArray(e)||t.join(",")!==e.join(","))},TAFFY.isSameObject=function(t,e){var n=TAFFY,r=!0;return n.isObject(t)&&n.isObject(e)&&n.isSameArray(n.getObjectKeys(t),n.getObjectKeys(e))?f(t,function(i,s){if(!(n.isObject(t[s])&&n.isObject(e[s])&&n.isSameObject(t[s],e[s])||n.isArray(t[s])&&n.isArray(e[s])&&n.isSameArray(t[s],e[s])||t[s]===e[s]))return r=!1,TAFFY.EXIT}):r=!1,r},t=["String","Number","Object","Array","Boolean","Null","Function","Undefined"],e=function(t){return function(e){return TAFFY.typeOf(e)===t.toLowerCase()}},n=0;n<t.length;n++)r=t[n],TAFFY["is"+r]=e(r)}(),"object"==typeof exports&&(exports.taffy=TAFFY);